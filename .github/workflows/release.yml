name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      version:
        description: "Version to release"
        required: true

permissions:
  contents: write

jobs:
  build-macos:
    runs-on: macos-14

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup build environment
        run: |
          brew install cmake ninja

      - name: Configure CMake
        run: |
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_OSX_ARCHITECTURES=arm64 \
            -DDIANA_BUILD_TESTS=OFF

      - name: Build
        run: cmake --build build --config Release

      - name: Run tests
        run: |
          cmake -B build -DDIANA_BUILD_TESTS=ON
          cmake --build build --config Release
          ctest --test-dir build --output-on-failure

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT
          fi

      - name: Package DMG
        env:
          VERSION: ${{ steps.version.outputs.version }}
        run: ./scripts/package-dmg.sh

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: diana-${{ steps.version.outputs.version }}-arm64
          path: build/*.dmg

  create-release:
    needs: build-macos
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT
          fi

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release files
        run: |
          mkdir -p release
          find artifacts -name "*.dmg" -exec cp {} release/ \;
          ls -la release/

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: Diana v${{ steps.version.outputs.version }}
          draft: false
          prerelease: ${{ contains(steps.version.outputs.version, 'alpha') || contains(steps.version.outputs.version, 'beta') }}
          files: release/*
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-homebrew:
    needs: create-release
    runs-on: ubuntu-latest
    if: ${{ !contains(github.ref, 'alpha') && !contains(github.ref, 'beta') }}

    steps:
      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT
          fi

      - name: Calculate SHA256 hashes
        id: hashes
        run: |
          VERSION=${{ steps.version.outputs.version }}
          OWNER=${{ github.repository_owner }}
          REPO=${{ github.event.repository.name }}
          
          curl -sL "https://github.com/${OWNER}/${REPO}/archive/refs/tags/v${VERSION}.tar.gz" -o source.tar.gz
          SOURCE_SHA=$(shasum -a 256 source.tar.gz | cut -d' ' -f1)
          echo "source_sha=${SOURCE_SHA}" >> $GITHUB_OUTPUT
          
          curl -sL "https://github.com/${OWNER}/${REPO}/releases/download/v${VERSION}/Diana-${VERSION}-arm64.dmg" -o arm64.dmg || true
          
          if [ -f arm64.dmg ]; then
            ARM_SHA=$(shasum -a 256 arm64.dmg | cut -d' ' -f1)
            echo "arm_sha=${ARM_SHA}" >> $GITHUB_OUTPUT
          fi

      - name: Ensure homebrew-diana exists
        env:
          HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          if [ -z "${HOMEBREW_TAP_TOKEN}" ]; then
            echo "HOMEBREW_TAP_TOKEN is required to create/update the tap repository."
            exit 1
          fi

          OWNER=${{ github.repository_owner }}
          TAP_REPO="homebrew-diana"
          API="https://api.github.com"
          AUTH_HEADER="Authorization: token ${HOMEBREW_TAP_TOKEN}"

          status=$(curl -s -o /dev/null -w "%{http_code}" -H "${AUTH_HEADER}" "${API}/repos/${OWNER}/${TAP_REPO}")
          if [ "${status}" -ne 200 ]; then
            payload="{\"name\":\"${TAP_REPO}\",\"private\":false,\"auto_init\":true}"
            create_status=$(curl -s -o /dev/null -w "%{http_code}" -H "${AUTH_HEADER}" -H "Accept: application/vnd.github+json" -d "${payload}" "${API}/user/repos")
            if [ "${create_status}" -ne 201 ]; then
              create_status=$(curl -s -o /dev/null -w "%{http_code}" -H "${AUTH_HEADER}" -H "Accept: application/vnd.github+json" -d "${payload}" "${API}/orgs/${OWNER}/repos")
            fi
            if [ "${create_status}" -ne 201 ]; then
              echo "Failed to create ${OWNER}/${TAP_REPO}. Ensure HOMEBREW_TAP_TOKEN has repo scope."
              exit 1
            fi
          fi

      - name: Checkout homebrew-diana
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/homebrew-diana
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          path: homebrew-diana

      - name: Update Formula
        run: |
          VERSION=${{ steps.version.outputs.version }}
          SOURCE_SHA=${{ steps.hashes.outputs.source_sha }}
          
          cd homebrew-diana
          mkdir -p Formula
          
          cat > Formula/diana.rb << 'EOF'
          class Diana < Formula
            desc "Mission control for AI agents - unified config management and token monitoring"
            homepage "https://github.com/taotao7/Diana"
            url "https://github.com/taotao7/Diana/archive/refs/tags/v${VERSION}.tar.gz"
            sha256 "${SOURCE_SHA}"
            license "MIT"
            head "https://github.com/taotao7/Diana.git", branch: "main"

            depends_on "cmake" => :build
            depends_on xcode: :build
            depends_on :macos

            def install
              system "cmake", "-S", ".", "-B", "build",
                              "-DCMAKE_BUILD_TYPE=Release",
                              "-DDIANA_BUILD_TESTS=OFF",
                              *std_cmake_args
              system "cmake", "--build", "build", "--parallel"
              bin.install "build/diana"
              (share/"diana/fonts").install Dir["resources/fonts/*"]
            end

            test do
              assert_predicate bin/"diana", :exist?
            end
          end
          EOF
          
          sed -i "s/\${VERSION}/${VERSION}/g" Formula/diana.rb
          sed -i "s/\${SOURCE_SHA}/${SOURCE_SHA}/g" Formula/diana.rb

      - name: Update Cask
        run: |
          VERSION=${{ steps.version.outputs.version }}
          ARM_SHA=${{ steps.hashes.outputs.arm_sha }}
          
          cd homebrew-diana
          mkdir -p Casks
          
          cat > Casks/diana.rb << EOF
          cask "diana" do
            version "${VERSION}"
            sha256 "${ARM_SHA}"

            url "https://github.com/taotao7/Diana/releases/download/v#{version}/Diana-#{version}-arm64.dmg"

            name "Diana"
            desc "Mission control for AI agents - unified config management and token monitoring"
            homepage "https://github.com/taotao7/Diana"

            livecheck do
              url :url
              strategy :github_latest
            end

            depends_on macos: ">= :monterey"
            depends_on arch: :arm64

            app "Diana.app"

            zap trash: [
              "~/.config/diana",
              "~/Library/Application Support/Diana",
              "~/Library/Preferences/com.diana.app.plist",
              "~/Library/Saved Application State/com.diana.app.savedState",
            ]
          end
          EOF

      - name: Commit and push
        run: |
          cd homebrew-diana
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "Update Diana to v${{ steps.version.outputs.version }}" || exit 0
          git push
